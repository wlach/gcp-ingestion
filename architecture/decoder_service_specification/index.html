<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Decoder Service Specification - GCP Ingestion</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">GCP Ingestion</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../..">Home</a>
                            </li>
                            <li >
                                <a href="../../ingestion-edge/">Edge Ingestion</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Beam Ingestion <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../ingestion-beam/">Overview</a>
</li>
                                    
<li >
    <a href="../../ingestion-beam/ingestion_testing_workflow/">Ingestion testing workflow</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Architecture <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../overview/">Overview</a>
</li>
                                    
<li >
    <a href="../differences_from_aws/">Differences from AWS</a>
</li>
                                    
<li >
    <a href="../pain_points/">Pain Points</a>
</li>
                                    
<li >
    <a href="../edge_migration_plan/">Edge Migration Plan</a>
</li>
                                    
<li >
    <a href="../reliability/">Reliability</a>
</li>
                                    
<li >
    <a href="../test_requirements/">Test requirements</a>
</li>
                                    
<li >
    <a href="../landfill_service_specification/">Landfill Service Specification</a>
</li>
                                    
<li >
    <a href="../edge_server_specification/">Edge Server Specification</a>
</li>
                                    
<li >
    <a href="../bigquery_sink_specification/">BigQuery Sink Specification</a>
</li>
                                    
<li class="active">
    <a href="./">Decoder Service Specification</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../bigquery_sink_specification/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="disabled">
                                <a rel="prev" >
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#decoder-service-specification">Decoder Service Specification</a></li>
            <li><a href="#data-flow">Data Flow</a></li>
            <li><a href="#other-considerations">Other Considerations</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="decoder-service-specification">Decoder Service Specification</h1>
<p>This document specifies the behavior of the service that decodes messages
in the Structured Ingestion pipeline.</p>
<h2 id="data-flow">Data Flow</h2>
<ol>
<li>Consume messages from Google Cloud PubSub raw topic</li>
<li>Decode the body from base64, optionally gzip, and JSON</li>
<li>Validate the schema of the body</li>
<li>Perform GeoIP lookup and drop <code>x_forwarded_for</code> and <code>remote_addr</code> and
   optionally <code>geo_city</code> based on population</li>
<li>Extract user agent information and drop <code>user_agent</code></li>
<li>Add metadata fields to message</li>
<li>Deduplicate message by <code>docId</code></li>
<li>Generate <code>docId</code> for submission types that don't have one</li>
<li>Write message to PubSub decoded topic based on <code>namespace</code> and <code>docType</code></li>
</ol>
<h3 id="implementation">Implementation</h3>
<p>The above steps will be executed as a single Apache Beam job that can accept
either a streaming input from PubSub or a batch input from Cloud Storage.
Message deduplication will be done by checking for the presence of ids as keys
in Cloud Memory Store (managed Redis).</p>
<h3 id="decoding-errors">Decoding Errors</h3>
<p>All messages that are rejected at any step of the Data Flow above will be
forwarded to a PubSub error topic for backfill and monitoring purposes.
If we determine that a message has already been successfully processed
based on <code>docId</code>, we drop the duplicated body and publish just the metadata
to the error topic.</p>
<h4 id="error-message-schema">Error message schema</h4>
<p>The message that failed decoding, with several additional attributes:</p>
<pre><code>...
required group attributes {
  ...
  required string error_type    // example: &quot;schema&quot;
  required string error_message // example: &quot;message did not match json schema for &lt;namespace&gt;/&lt;docVersion&gt;/&lt;docType&gt;&quot;
  required string exception_class // example: &quot;java.lang.RuntimeException&quot;
  required string stack_trace
  optional string stack_trace_cause_1
  optional string stack_trace_cause_2
  optional string stack_trace_cause_3
  optional string stack_trace_cause_4
  optional string stack_trace_cause_5
}
</code></pre>

<h3 id="raw-message-schema">Raw message schema</h3>
<p>See <a href="../edge_server_specification/#edge-server-pubsub-message-schema">Edge Server PubSub Message Schema</a>.</p>
<h3 id="decoded-message-metadata-schema">Decoded message metadata schema</h3>
<p>Decoded messages published to Pub/Sub will contain the following attributes:</p>
<pre><code>required group attributes {
  ...
  required string document_version           // from uri for non-Telemetry, from message for Telemetry
  required string document_id                // from uri
  required string document_namespace         // from uri
  required string document_type              // from uri
  optional string app_name                   // from uri for Telemetry
  optional string app_version                // from uri for Telemetry
  optional string app_update_channel         // from uri for Telemetry
  optional string app_build_id               // from uri for Telemetry
  optional string geo_country                // from geoip lookup
  optional string geo_subdivision1           // from geoip lookup
  optional string geo_subdivision2           // from geoip lookup
  optional string geo_city                   // from geoip lookup
  required string submission_timestamp       // from edge metadata
  optional string date                       // header from client
  optional string dnt                        // header from client
  optional string x_pingsender_version       // header from client
  optional string x_debug_id                 // header from client
  optional string user_agent_browser         // from user_agent
  optional string user_agent_browser_version // from user_agent
  optional string user_agent_os              // from user_agent
  optional string user_agent_os_version      // from user_agent
  optional string normalized_app_name        // based on parsed json payload
  optional string normalized_channel         // based on parsed json payload or URI
  required string normalized_country_code    // from geoip lookup
  optional string normalized_os              // based on parsed json payload
  optional string normalized_os_version      // based on parsed json payload
  optional string sample_id                  // based on parsed json payload
}
</code></pre>

<p>Many of these fields are also injected into the JSON payload either at the top
level or nested inside a <code>metadata</code> object. The schema for injected metadata
is maintained under the <a href="https://github.com/mozilla-services/mozilla-pipeline-schemas/tree/dev/schemas/metadata"><code>metadata</code> namespace in <code>mozilla-pipeline-schemas</code></a>.</p>
<h2 id="other-considerations">Other Considerations</h2>
<h3 id="message-acks">Message Acks</h3>
<p>Messages should only be acknowledged in the PubSub raw topic subscription after
delivery to either a decoded topic or the error topic.</p>
<p>If this is not possible then any time a message is not successfully delivered
to PubSub it should by treated as lost data and the appropriate time window
will be backfilled from Cloud Storage in batch mode, and appropriate steps will
be taken downstream to handle the backfill.</p>
<p>Deployments should always terminate functional pipelines using the <code>drain</code>
method, to ensure ack'd messages are fully delivered.</p>
<h3 id="deduplication">Deduplication</h3>
<p>Each <code>docId</code> will be allowed through "at least once", and only be
rejected as a duplicate if we have completed delivery of a message with the
same <code>docId</code>. Duplicates will be considered errors and sent to the error topic.
"Exactly once" semantics can be applied to derived data sets using SQL in
BigQuery, and GroupByKey in Beam and Spark.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"search": 83, "next": 78, "help": 191, "previous": 80};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
